name: Notify Author on Status Change

on:
  issues:
    types: [labeled, unlabeled, edited]
  project_card:
    types: [moved, created]

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: Check project status and notify
        uses: actions/github-script@v7
        with: 
          github-token: ${{ secrets. GITHUB_TOKEN }}
          script:  |
            const issue = context. payload.issue;
            if (! issue) {
              console.log('No issue found in payload');
              return;
            }
            
            const author = issue.user.login;
            const issueNumber = issue.number;
            const repo = context.repo;
            
            console.log(`Processing issue #${issueNumber} by @${author}`);
            
            // Query GraphQL API to get project status
            const query = `
              query($owner: String!, $name: String!, $issueNumber: Int!) {
                repository(owner: $owner, name:  $name) {
                  issue(number: $issueNumber) {
                    projectItems(first: 20) {
                      nodes {
                        id
                        project {
                          title
                          number
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ...  on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ...  on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const variables = {
              owner: repo.owner,
              name: repo.repo,
              issueNumber: issueNumber
            };
            
            try {
              const result = await github.graphql(query, variables);
              const projectItems = result.repository.issue.projectItems. nodes;
              
              console. log(`Found ${projectItems.length} project items`);
              
              // Check each project item for status
              for (const item of projectItems) {
                console.log(`Checking project: ${item.project.title} (${item.project.number})`);
                
                // Only check project #4
                if (item.project.number !== 4) {
                  console.log(`Skipping project ${item.project.number}`);
                  continue;
                }
                
                for (const fieldValue of item.fieldValues.nodes) {
                  if (fieldValue.field && fieldValue.field.name === 'Status') {
                    const status = fieldValue.name;
                    console.log(`Current status: ${status}`);
                    
                    // Check if we've already notified about this status
                    const comments = await github.rest.issues. listComments({
                      owner: repo.owner,
                      repo: repo.repo,
                      issue_number: issueNumber,
                    });
                    
                    const statusNotificationPattern = new RegExp(`status.*updated to.*\\*\\*${status}\\*\\*`, 'i');
                    const alreadyNotified = comments. data.some(comment => 
                      comment.user.type === 'Bot' && 
                      statusNotificationPattern.test(comment. body)
                    );
                    
                    if (!alreadyNotified) {
                      let notificationBody = `ðŸ‘‹ @${author}, the status of this issue has been updated to **${status}**. `;
                      
                      // Special handling for "In Review" status
                      if (status. toLowerCase() === 'in review') {
                        console.log('Status is "In Review" - creating task for author');
                        
                        notificationBody += `\n\n### ðŸ“‹ Action Required\n\n**Task:** Please review the implemented fix and provide your feedback.\n\n- [ ] Review the changes\n- [ ] Test the implementation\n- [ ] Provide feedback or approve`;
                      }
                      
                      await github.rest.issues.createComment({
                        owner:  repo.owner,
                        repo: repo.repo,
                        issue_number: issueNumber,
                        body: notificationBody
                      });
                      
                      console.log('Notification comment posted');
                    } else {
                      console.log(`Already notified about "${status}" status - skipping duplicate comment`);
                    }
                  }
                }
              }
            } catch (error) {
              console.error('Error querying project data:', error);
              throw error;
            }
