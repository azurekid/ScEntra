name: Notify Author on Status Change
description: Automatically notify author on issues changes
on:
  issues:
    types: [labeled, unlabeled, edited, opened, reopened]
  workflow_dispatch:
jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      # If needed for Projects v2, replace with a PAT:
      # id-token: write
      # pull-requests: read
    steps:
      - name: Check project status and notify
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # or PROJECT_ACCESS_TOKEN if needed
          script: |
            const issue = context.payload.issue;
            if (!issue) {
              console.log('No issue found in payload');
              return;
            }

            const author = issue.user.login;
            const issueNumber = issue.number;
            const repo = context.repo;

            console.log(`Processing issue #${issueNumber} by @${author}`);
            console.log(`Repository: ${repo.owner}/${repo.repo}`);

            const query = `
              query($owner: String!, $name: String!, $issueNumber: Int!) {
                repository(owner: $owner, name: $name) {
                  issue(number: $issueNumber) {
                    projectItems(first: 20) {
                      nodes {
                        id
                        project {
                          title
                          number
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: repo.owner,
              name: repo.repo,
              issueNumber,
            };

            try {
              const result = await github.graphql(query, variables);
              console.log('=== FULL GRAPHQL RESPONSE ===');
              console.log(JSON.stringify(result, null, 2));
              console.log('=== END RESPONSE ===');

              const projectItems = result.repository.issue.projectItems.nodes;
              console.log(`Found ${projectItems.length} project items`);

              if (projectItems.length === 0) {
                console.log('‚ö†Ô∏è No project items found for this issue.');
                return;
              }

              for (const item of projectItems) {
                console.log('');
                console.log(`--- Checking project: ${item.project.title} (Number: ${item.project.number}) ---`);

                if (item.project.number !== 4) {
                  console.log(`‚è≠Ô∏è Skipping project ${item.project.number} (not target project #4)`);
                  continue;
                }

                console.log('‚úÖ This is the target project (#4)');

                for (const fieldValue of item.fieldValues.nodes) {
                  if (fieldValue.field && fieldValue.field.name === 'Status') {
                    const status = fieldValue.name;
                    console.log(`üìä Current status: "${status}"`);

                    const comments = await github.rest.issues.listComments({
                      owner: repo.owner,
                      repo: repo.repo,
                      issue_number: issueNumber,
                    });

                    const statusNotificationPattern = new RegExp(`status.*updated to.*\\*\\*${status}\\*\\*`, 'i');
                    const alreadyNotified = comments.data.some(comment => {
                      const isBot = comment.user.type === 'Bot';
                      const matchesPattern = statusNotificationPattern.test(comment.body || '');
                      return isBot && matchesPattern;
                    });

                    if (!alreadyNotified) {
                      let notificationBody = `üëã @${author}, the status of this issue has been updated to **${status}**.`;

                      if (status.toLowerCase() === 'in review') {
                        notificationBody += `
### üìã Action Required

**Task:** Please review the implemented fix and provide your feedback.

- [ ] Review the changes
- [ ] Test the implementation
- [ ] Confirm whether the issue is resolved
`;
                      }

                      await github.rest.issues.createComment({
                        owner: repo.owner,
                        repo: repo.repo,
                        issue_number: issueNumber,
                        body: notificationBody,
                      });

                      console.log('‚úÖ Notification comment posted successfully');
                    } else {
                      console.log(`‚ÑπÔ∏è Already notified about "${status}" status - skipping duplicate comment`);
                    }

                    break;
                  }
                }
              }

              console.log('');
              console.log('=== Workflow completed successfully ===');
            } catch (error) {
              console.error('‚ùå Error querying project data:');
              console.error('Error name:', error.name);
              console.error('Error message:', error.message);
              if (error.errors) {
                console.error('GraphQL errors:', JSON.stringify(error.errors, null, 2));
              }
              throw error;
            }
